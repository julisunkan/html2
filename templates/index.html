<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailCraft - HTML Email Creator</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#007BFF">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">‚úâÔ∏è MailCraft - HTML Email Creator</span>
        </div>
    </nav>

    <div id="notification-container" class="container-fluid mt-3"></div>

    <!-- Image Insertion Modal -->
    <div class="modal fade" id="imageInsertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Insert Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <img id="modal-preview-image" src="" alt="Preview" class="img-fluid mb-3" style="max-height: 200px;">
                    </div>
                    <div class="mb-3">
                        <label for="image-width" class="form-label">Width (px or %)</label>
                        <input type="text" class="form-control" id="image-width" value="300" placeholder="e.g., 300 or 100%">
                    </div>
                    <div class="mb-3">
                        <label for="image-align" class="form-label">Alignment</label>
                        <select class="form-select" id="image-align">
                            <option value="left">Left</option>
                            <option value="center" selected>Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="image-alt" class="form-label">Alt Text (optional)</label>
                        <input type="text" class="form-control" id="image-alt" placeholder="Description of image">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="insertImageIntoBody()">Insert Image</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">{% if edit_template %}Edit Template{% else %}Create New Template{% endif %}</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% if edit_template %}{{ url_for('update_template', template_id=edit_template.id) }}{% else %}{{ url_for('save_template') }}{% endif %}" id="emailForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label for="title" class="form-label">Template Title</label>
                                <input type="text" class="form-control" id="title" name="title" value="{% if edit_template %}{{ edit_template.title }}{% endif %}" required hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">
                            </div>

                            <div class="mb-3">
                                <label for="subject" class="form-label">Email Subject</label>
                                <input type="text" class="form-control" id="subject" name="subject" value="{% if edit_template %}{{ edit_template.subject }}{% endif %}" required>
                            </div>

                            <div class="mb-3">
                                <label for="template_name" class="form-label">Template Design</label>
                                <select class="form-select" id="template_name" name="template_name" hx-post="/preview" hx-target="#live-preview" hx-trigger="change" hx-include="#emailForm">
                                    {% set selected_template = edit_template.template_name if edit_template else 'template1' %}
                                    <option value="template1" {% if selected_template == 'template1' %}selected{% endif %}>Template 1 - Blue Professional</option>
                                    <option value="template2" {% if selected_template == 'template2' %}selected{% endif %}>Template 2 - Red Bold</option>
                                    <option value="template3" {% if selected_template == 'template3' %}selected{% endif %}>Template 3 - Green Fresh</option>
                                    <option value="template4" {% if selected_template == 'template4' %}selected{% endif %}>Template 4 - Purple Elegant</option>
                                    <option value="template5" {% if selected_template == 'template5' %}selected{% endif %}>Template 5 - Orange Vibrant</option>
                                    <option value="template6" {% if selected_template == 'template6' %}selected{% endif %}>Template 6 - Teal Modern</option>
                                    <option value="template7" {% if selected_template == 'template7' %}selected{% endif %}>Template 7 - Pink Cheerful</option>
                                    <option value="template8" {% if selected_template == 'template8' %}selected{% endif %}>Template 8 - Indigo Corporate</option>
                                    <option value="template9" {% if selected_template == 'template9' %}selected{% endif %}>Template 9 - Amber Warm</option>
                                    <option value="template10" {% if selected_template == 'template10' %}selected{% endif %}>Template 10 - Cyan Cool</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="header" class="form-label">Header Text</label>
                                <input type="text" class="form-control" id="header" name="header" value="{% if edit_template %}{{ edit_template.header }}{% endif %}" required hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">
                            </div>

                            <div class="mb-3">
                                <label for="body" class="form-label">Body Content</label>
                                <textarea class="form-control" id="body" name="body" rows="5" required hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">{% if edit_template %}{{ edit_template.body }}{% endif %}</textarea>
                                <small class="text-muted">üí° Drag images from below to insert them into your email body</small>
                                
                                {% if uploaded_images %}
                                <div class="mt-2 p-2 border rounded" style="background: #f8f9fa;">
                                    <div class="d-flex gap-2 overflow-auto" style="max-height: 120px;">
                                        {% for image in uploaded_images %}
                                        <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                                             alt="{{ image }}" 
                                             class="draggable-image" 
                                             draggable="true"
                                             data-image-url="{{ url_for('static', filename='uploads/' + image, _external=True) }}"
                                             style="height: 80px; width: auto; cursor: grab; border: 2px solid transparent; border-radius: 4px; transition: all 0.2s;"
                                             onmouseover="this.style.borderColor='#007BFF'"
                                             onmouseout="this.style.borderColor='transparent'">
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="button_text" class="form-label">Button Text (Optional)</label>
                                <input type="text" class="form-control" id="button_text" name="button_text" value="{% if edit_template %}{{ edit_template.button_text }}{% endif %}" hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">
                            </div>

                            <div class="mb-3">
                                <label for="button_link" class="form-label">Button Link (Optional)</label>
                                <input type="url" class="form-control" id="button_link" name="button_link" value="{% if edit_template %}{{ edit_template.button_link }}{% endif %}" placeholder="https://example.com" hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">
                            </div>

                            <div class="mb-3">
                                <label for="footer" class="form-label">Footer Text</label>
                                <input type="text" class="form-control" id="footer" name="footer" value="{% if edit_template %}{{ edit_template.footer }}{% endif %}" hx-post="/preview" hx-target="#live-preview" hx-trigger="keyup changed delay:500ms" hx-include="#emailForm">
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">üíæ {% if edit_template %}Update{% else %}Save{% endif %} Template</button>
                            </div>
                        </form>

                        <div class="d-grid gap-2 mt-2">
                            <button type="button" class="btn btn-primary" onclick="exportCurrentTemplate()">‚¨áÔ∏è Export HTML</button>
                        </div>

                        <form method="POST" action="{{ url_for('export_current') }}" id="exportForm" style="display: none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="title" id="export_title">
                            <input type="hidden" name="subject" id="export_subject">
                            <input type="hidden" name="template_name" id="export_template_name">
                            <input type="hidden" name="header" id="export_header">
                            <input type="hidden" name="body" id="export_body">
                            <input type="hidden" name="button_text" id="export_button_text">
                            <input type="hidden" name="button_link" id="export_button_link">
                            <input type="hidden" name="footer" id="export_footer">
                        </form>

                        <hr>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üñºÔ∏è Upload Image</h6>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('upload_image') }}" enctype="multipart/form-data">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" name="image" accept="image/*" required>
                                        <small class="text-muted">Supported: PNG, JPG, JPEG, GIF, WebP (Max 16MB)</small>
                                    </div>
                                    <button type="submit" class="btn btn-outline-primary w-100">Upload Image</button>
                                </form>
                                <div id="uploaded-images" class="mt-3"></div>
                                
                                {% if uploaded_images %}
                                <div class="mt-3">
                                    <h6 class="text-muted mb-2">üìÅ Your Uploaded Images</h6>
                                    <div class="uploaded-images-list">
                                        {% for image in uploaded_images %}
                                        <div class="image-item card mb-2">
                                            <div class="card-body p-2">
                                                <div class="row align-items-center">
                                                    <div class="col-3">
                                                        <img src="{{ url_for('static', filename='uploads/' + image) }}" alt="{{ image }}" class="img-thumbnail" style="max-height: 60px; width: auto;">
                                                    </div>
                                                    <div class="col-7">
                                                        <small class="d-block text-muted mb-1">{{ image }}</small>
                                                        <div class="input-group input-group-sm">
                                                            <input type="text" class="form-control form-control-sm" value="{{ url_for('static', filename='uploads/' + image, _external=True) }}" readonly onclick="this.select(); copyToClipboard(this.value)">
                                                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyToClipboard('{{ url_for('static', filename='uploads/' + image, _external=True) }}')">üìã</button>
                                                        </div>
                                                        <small class="text-muted">Click URL to copy ‚Ä¢ Use in email body: &lt;img src="URL"&gt;</small>
                                                    </div>
                                                    <div class="col-2 text-end">
                                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="showImageDeleteConfirmation('{{ image }}')">üóëÔ∏è</button>
                                                        <form method="POST" action="{{ url_for('delete_image', filename=image) }}" id="delete-image-form-{{ image }}" style="display: none;">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üìã Saved Templates</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        {% if saved_templates %}
                            <div class="list-group">
                                {% for template in saved_templates %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ template.title }}</h6>
                                            <small class="text-muted">{{ template.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_template', template_id=template.id) }}" class="btn btn-outline-primary" target="_blank">View</a>
                                            <a href="{{ url_for('edit_template', template_id=template.id) }}" class="btn btn-outline-secondary">Edit</a>
                                            <a href="{{ url_for('export_template', template_id=template.id) }}" class="btn btn-outline-success">Export</a>
                                            <button type="button" class="btn btn-outline-danger" onclick="showDeleteConfirmation({{ template.id }}, '{{ template.title }}')">Delete</button>
                                            <form method="POST" action="{{ url_for('delete_template', template_id=template.id) }}" id="delete-form-{{ template.id }}" style="display: none;">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center">No templates saved yet. Create your first template!</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üëÅÔ∏è Live Preview</h5>
                    </div>
                    <div class="card-body" style="background: #f5f5f5; min-height: 600px; overflow-y: auto;">
                        {% if uploaded_images %}
                        <div id="uploaded-images-preview" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                            <h6 class="text-muted mb-3">üìÅ Your Uploaded Images</h6>
                            <div class="row g-2">
                                {% for image in uploaded_images %}
                                <div class="col-md-6">
                                    <div class="card">
                                        <img src="{{ url_for('static', filename='uploads/' + image) }}" alt="{{ image }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block" style="font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ image }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div id="live-preview" style="background: white; border-radius: 8px; padding: 20px;">
                            <p class="text-center text-muted">Start typing to see your email preview...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/service-worker.js');
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-danger' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            notification.className = `alert ${alertClass} alert-dismissible fade show`;
            notification.innerHTML = `
                <strong>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ'}</strong> ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            container.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 150);
                }, duration);
            }
        }

        function showDeleteConfirmation(templateId, templateTitle) {
            const container = document.getElementById('notification-container');
            const confirmation = document.createElement('div');
            
            confirmation.className = 'alert alert-warning alert-dismissible fade show';
            confirmation.innerHTML = `
                <strong>‚ö† Confirm Deletion</strong><br>
                Are you sure you want to delete "${templateTitle}"?
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-danger me-2" onclick="confirmDelete(${templateId})">Yes, Delete</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="this.closest('.alert').remove()">Cancel</button>
                </div>
            `;
            
            container.innerHTML = '';
            container.appendChild(confirmation);
        }

        function confirmDelete(templateId) {
            document.getElementById('delete-form-' + templateId).submit();
        }

        function showImageDeleteConfirmation(filename) {
            const container = document.getElementById('notification-container');
            const confirmation = document.createElement('div');
            
            confirmation.className = 'alert alert-warning alert-dismissible fade show';
            confirmation.innerHTML = `
                <strong>‚ö† Confirm Deletion</strong><br>
                Are you sure you want to delete "${filename}"?
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-danger me-2" onclick="confirmImageDelete('${filename}')">Yes, Delete</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="this.closest('.alert').remove()">Cancel</button>
                </div>
            `;
            
            container.innerHTML = '';
            container.appendChild(confirmation);
        }

        function confirmImageDelete(filename) {
            document.getElementById('delete-image-form-' + filename).submit();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('URL copied to clipboard!', 'success', 2000);
            }).catch(() => {
                showNotification('Failed to copy URL', 'error', 2000);
            });
        }

        function exportCurrentTemplate() {
            const fields = ['title', 'subject', 'template_name', 'header', 'body', 'button_text', 'button_link', 'footer'];
            fields.forEach(field => {
                document.getElementById('export_' + field).value = document.getElementById(field).value;
            });
            document.getElementById('exportForm').submit();
            showNotification('Exporting template...', 'info', 2000);
        }

        let currentImageUrl = '';

        function insertImageIntoBody() {
            const width = document.getElementById('image-width').value;
            const align = document.getElementById('image-align').value;
            const alt = document.getElementById('image-alt').value;
            
            const alignStyle = align === 'center' ? 'display: block; margin: 0 auto;' : 
                              align === 'right' ? 'float: right; margin-left: 10px;' : 
                              'float: left; margin-right: 10px;';
            
            const widthAttr = width.includes('%') ? `width: ${width};` : `width: ${width}px;`;
            
            const imgTag = `<img src="${currentImageUrl}" alt="${alt}" style="${alignStyle} ${widthAttr} max-width: 100%; height: auto;">`;
            
            const bodyTextarea = document.getElementById('body');
            const cursorPos = bodyTextarea.selectionStart;
            const textBefore = bodyTextarea.value.substring(0, cursorPos);
            const textAfter = bodyTextarea.value.substring(cursorPos);
            
            bodyTextarea.value = textBefore + imgTag + textAfter;
            
            // Trigger preview update
            htmx.trigger(bodyTextarea, 'keyup');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('imageInsertModal'));
            modal.hide();
            
            showNotification('Image inserted successfully!', 'success', 2000);
        }

        function setupDragAndDrop() {
            const draggableImages = document.querySelectorAll('.draggable-image');
            const bodyTextarea = document.getElementById('body');
            
            draggableImages.forEach(img => {
                img.addEventListener('dragstart', function(e) {
                    currentImageUrl = this.getAttribute('data-image-url');
                    this.style.cursor = 'grabbing';
                });
                
                img.addEventListener('dragend', function(e) {
                    this.style.cursor = 'grab';
                });
                
                img.addEventListener('click', function(e) {
                    currentImageUrl = this.getAttribute('data-image-url');
                    document.getElementById('modal-preview-image').src = currentImageUrl;
                    const modal = new bootstrap.Modal(document.getElementById('imageInsertModal'));
                    modal.show();
                });
            });
            
            if (bodyTextarea) {
                bodyTextarea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#007BFF';
                    this.style.borderWidth = '2px';
                });
                
                bodyTextarea.addEventListener('dragleave', function(e) {
                    this.style.borderColor = '#ced4da';
                    this.style.borderWidth = '1.5px';
                });
                
                bodyTextarea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ced4da';
                    this.style.borderWidth = '1.5px';
                    
                    if (currentImageUrl) {
                        document.getElementById('modal-preview-image').src = currentImageUrl;
                        const modal = new bootstrap.Modal(document.getElementById('imageInsertModal'));
                        modal.show();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('emailForm');
            htmx.trigger(form, 'keyup');
            
            setupDragAndDrop();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'saved') {
                showNotification('Template saved successfully!', 'success');
            } else if (urlParams.get('success') === 'updated') {
                showNotification('Template updated successfully!', 'success');
            } else if (urlParams.get('success') === 'deleted') {
                showNotification('Template deleted successfully!', 'success');
            } else if (urlParams.get('success') === 'image_uploaded') {
                const imageUrl = urlParams.get('image_url');
                const filename = urlParams.get('filename');
                showNotification('Image uploaded and inserted into body! Image now visible in Live Preview.', 'success');
                if (imageUrl) {
                    navigator.clipboard.writeText(imageUrl).catch(() => {});
                    
                    // Auto-insert image into body
                    const bodyTextarea = document.getElementById('body');
                    const imgTag = `<img src="${imageUrl}" alt="${filename}" style="display: block; margin: 20px auto; max-width: 100%; height: auto; width: 500px;">`;
                    
                    if (bodyTextarea.value.trim() === '') {
                        bodyTextarea.value = imgTag;
                    } else {
                        bodyTextarea.value = bodyTextarea.value + '\n\n' + imgTag;
                    }
                    
                    // Trigger preview update
                    htmx.trigger(bodyTextarea, 'keyup');
                }
            } else if (urlParams.get('success') === 'image_deleted') {
                showNotification('Image deleted successfully!', 'success');
            } else if (urlParams.get('error')) {
                showNotification(urlParams.get('error'), 'error');
            }
        });
    </script>
</body>
</html>
